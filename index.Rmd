---
title: ""
output:
  html_document:
    toc: no
    toc_float: yes
    collapsed: no
    number_sections: no
    toc_depth: 3
    css: front.css
  pdf_document:
    toc: yes
    toc_depth: '4'
---


## Philadelphia Public Schools {.tabset}

### Overview

Sample of a 2020 project with Yale National Initiative to Strengthen Teaching in the Public Schools (YNI)

Background

The Teachers Institute of Philadelphia (TIP), a University of Pennsylvania-based teacher professional development program, has served the School District of Philadelphia (SDP) since 2006. TIP’s approach is based on the theory that, given the opportunity to grow intellectually and shape their classroom practices, teachers will be more engaged with their work and motivated to do their best—and that this will lead to higher rates of teacher retention and more effective teaching. TIP teachers enroll in a seminar in which they learn new content from an expert in the discipline, develop a curriculum unit that connects that content to their required teaching, and test it the classroom. A key part of this process is the lively exchange of information between colleagues that takes place in the seminar meetings (Kisker, 2011). Fortified with new information, new teaching ideas and the reinforcement that comes from peer exchange, teachers consistently report on institute- administered questionnaires that their morale has been improved: they are more confident in their knowledge of the subjects they teach and in their ability to teach them. They also report that their students are more engaged with their learning.

Based on a study conducted by TIP’s parent institution, the Yale National Initiative to Strengthen Teaching in the Public Schools (YNI), TIP believes that its approach leads to higher retention rates for teachers in urban public schools. Conducted in the New Haven public schools, this study found that Institute fellows were nearly twice as likely to remain in their jobs over a five-year period as demographically similar teachers who were not enrolled in the program. As part of this evaluation, we will replicate the New Haven retention study in Philadelphia, using propensity matching to eliminate the self-selection bias.


### Data

* Data private as per request of School District of Philadelphia

Packages

* [Tidyverse](https://cran.r-project.org/web/packages/tidyverse/tidyverse.pdf)
* [MatchIt](https://cran.r-project.org/web/packages/MatchIt/index.html)

</div>
<div class="col-sm-6">


</div>
<div class="col-sm-6">
<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover(); 
});
</script>
```{r eval=FALSE, message=FALSE, include=FALSE}
set.seed(1731)
# trimming the sample
analysis_data_trimmed <- analysis_data %>%
  filter(YearsOfService %in% c(0:31, 33,34,35,36,37,39))
nearest <- matchit(Participated ~
                     Gender+ Ethnicity + Strata + employeeage+ title_status
                     ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data_trimmed)
summary(nearest)
###plotting these
plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
summary(model)
```

### Data Cleaning and Visualization
The initial data set consisted of 16,013 unique, 7,014 of whom we have information on exiting
the school system. A total of 356 unique teachers who participated in TIP. After checking for
missing data, 4 observations in teacher exits were coded as duplicates, and 2 observations in the
TIP participation variables set were duplicates. Of the demographic variables, 43 observations
were NA (missing). Of the total teachers set, 32 observations were NA. After removing the NA
values, the analytic file included 16,005 unique teachers.
Upon merging the datasets, it became apparent that some unique teacher IDs were present in
certain datasets but missing from others. Specifically, using the anti-merge function in our code,
we can see the observations that are included in the information on exits but not in the
information on total teachers. There are 1,067 teachers who exited, and who were also missing
from the total teachers data. We removed these missing values from the merge of teacher exits
with the total teachers.
We proceeded to merge the deidentified TIP IDs with the complete teachers file. Of the TIP
participants, 44 unique teachers were missing from the total teachers set. This brings our final
number of unique teachers who participated in TIP (with complete covariate information) down
from 358 to 314. After removing two duplicates, the final number of unique TIP participants in
the dataset is 312.
In the descriptive statistics and statistical analyses below, we use a final analytic file that consists
of 16,005 teachers, of which 312 participated in TIP. This information is based on the 8-year
period from 2010 – 2018. 


```{r chunk1, echo=TRUE, fig.show='hold', message=FALSE, warning=FALSE}
library(dplyr)
library(kableExtra)
library(tidyverse)

#initial missingness changes
rm(list = ls()) #clear the environment

##remove the year variables out of each
load("scripts/merged_participation_analysis.Rdata")

#create a new table to work with that has one entry for each De ID

table_part <- merged_participation %>%
  filter(Participated == 1) %>%
  select(`Deidentified ID`, Title, Gender, Ethnicity, `Employee Age`, Organization, `Years of Service`, Retained, Strata, Participated) %>%
    group_by(`Deidentified ID`)
df.agg <- aggregate(`Employee Age` ~ `Deidentified ID`, table_part, max)
table_part <- merge(df.agg, table_part)
save(table_part, file = "data/table_part.Rdata")
table_nonpart <- merged_participation %>%
  filter(Participated == 0) %>%
  select(`Deidentified ID`, Title, Gender, Ethnicity, `Employee Age`, Organization, `Years of Service`, Retained, Strata, Participated)%>%
    group_by(`Deidentified ID`)
df.agg <- aggregate(`Employee Age` ~ `Deidentified ID`, table_nonpart, max)
table_nonpart <- merge(df.agg, table_nonpart)
save(table_nonpart, file = "data/table_nonpart.Rdata")

#create proportion tables
table_part_strat <- table_part %>%
  group_by(Strata) %>%
  dplyr::summarise(total = n())
#change to numeric
table_part_strat$total <- as.numeric(table_part_strat$total)
#add a new column with total
table_part_strat <- table_part_strat %>%
  mutate(overall = colSums(table_part_strat[,2])) %>%
  mutate(proportion = total/overall) %>%
  select(Strata, total, proportion) %>%
  mutate(order = NA)


#recode the factors
table_part_strat$strata <- as.factor(table_part_strat$Strata)
table_part_strat$strata <- recode_factor(table_part_strat$Strata, `1` = "less than 5", `2` = "5 to less than 10 years", `3` = "10 to 15 years", `4` = "greater than or equal to 15")
table_part_strat <- table_part_strat %>%
  arrange(Strata) %>%
  select(Strata, total, proportion)
library(scales)
table_part_strat$proportion <- percent(table_part_strat$proportion)

#print a kable table
#kable(table_part_strat, "latex", booktabs = T, caption = "Strata Table of Participants") %>%
 # kable_styling(latex_options = c("repeat_header", "striped", "hover"), font_size = 12, repeat_header_text = "TABLE")

#check length
#length(unique(table_part$`Deidentified ID`))

#same for non-participants
table_nonpart_strat <- table_nonpart %>%
  group_by(Strata) %>%
  dplyr::summarise(total = n())
#change to numeric
table_nonpart_strat$total <- as.numeric(table_nonpart_strat$total)
#add a new column with total
table_nonpart_strat <- table_nonpart_strat %>%
  mutate(overall = colSums(table_nonpart_strat[,2])) %>%
  mutate(proportion = total/overall) %>%
  select(Strata, total, proportion) %>%
  mutate(order = NA)
#recode the factors
table_nonpart_strat$Strata <- as.factor(table_nonpart_strat$Strata)
#levels(table_nonpart_strat$strata)
table_nonpart_strat$Strata <- recode_factor(table_nonpart_strat$Strata, `1` = "less than 5", `2` = "5 to less than 10 years", `3` = "10 to 15 years", `4` = "greater than or equal to 15")
table_nonpart_strat <- table_nonpart_strat %>%
  arrange(Strata) %>%
  select(Strata, total, proportion)
library(scales)
table_nonpart_strat$proportion <- percent(table_nonpart_strat$proportion)
table_part_strat_2<- table_part_strat %>%
  rename("Strata of TIP Participants" = `Strata`)
table_nonpart_strat_2 <- table_nonpart_strat %>%
  rename("Strata of non Participants" = `Strata`)
# combined <- bind_cols(table_part_strat_2, table_nonpart_strat_2) %>%
#   rename("total" = `total1`,
#          "proportion" = `proportion1`)

#print kable table
#kable(combined, "latex", booktabs = T, caption = "Strata Comparisons for TIP and non TIP participants") %>%
#  kable_styling(latex_options = c("repeat_header", "striped", "scale_down"), font_size = 12, repeat_header_text = "TABLE")




```



```{r chunk100, echo=TRUE, fig.show='hold', message=FALSE, warning=FALSE}
#create proportion tables
total_table <- bind_rows(table_nonpart, table_part)
table_proportions <- total_table %>%
  group_by(Strata, Retained, Participated) %>%
  dplyr::summarise(total = n()) %>%
  spread(key = Retained, value = total) %>%
  mutate(totals = `0` + `1`) %>%
  mutate(liklihood_not_retained = `0` / totals) %>%
  mutate(liklihood_retained = `1` / totals)

##make this proportion table
#recode the factors
total_table$strata <- as.factor(total_table$Strata)
#levels(total_table$strata)
total_table$strata <- recode_factor(total_table$Strata, `1` = "less than 5", `2` = "5 to less than 10 years", `3` = "10 to 15 years", `4` = "greater than or equal to 15")
table_proportions <- total_table %>%
  group_by(Strata, Retained, Participated) %>%
  dplyr::summarise(total = n()) %>%
  spread(key = Retained, value = total) %>%
  mutate(totals = `0` + `1`) %>%
  mutate(`Likelihood of leaving profession` = `0` / totals) %>%
  mutate(`Likelihood of retention` = `1` / totals) %>%
  arrange(Strata)
library(scales)
table_proportions$`Likelihood of leaving profession` <- percent(table_proportions$`Likelihood of leaving profession`)
table_proportions$`Likelihood of retention` <- percent(table_proportions$`Likelihood of retention`)
table_proportions$totals <- NULL
# #print kable table
# kable(table_proportions, "latex", booktabs = T, caption = "Liklihood of Retention") %>%
#   kable_styling(latex_options = c("repeat_header", "striped", "scale_down"), font_size = 12, repeat_header_text = "TABLE") %>%
#   column_spec(5:6, width = "4cm")


```

```{r chunk3.8, echo=FALSE, fig.show='hold', message=FALSE, warning=FALSE}


#append together
 table_plot <- bind_rows(table_nonpart, table_part)


#create proportion tables
table_proportions <- table_plot %>%
  filter(Participated == 1) %>%
  group_by(Strata) %>%
  dplyr::summarise(total = n())
#change to numeric
table_proportions$total <- as.numeric(table_proportions$total)
#add a new column with total
table_proportions <- table_proportions %>%
  mutate(overall = colSums(table_proportions[,2])) %>%
  mutate(proportion = total/overall) %>%
  select(Strata, total, proportion) %>%
  mutate(Participated = 1)
#nonpart
table_proportions2 <- table_plot %>%
  filter(Participated == 0) %>%
  group_by(Strata) %>%
  dplyr::summarise(total = n())
#change to numeric
table_proportions2$total <- as.numeric(table_proportions2$total)
#add a new column with total
table_proportions2 <- table_proportions2 %>%
  mutate(overall = colSums(table_proportions2[,2])) %>%
  mutate(proportion = total/overall) %>%
  select(Strata, total, proportion) %>%
  mutate(Participated = 0)
#put together
plot3data <- bind_rows(table_proportions2, table_proportions) %>%
  mutate(partic = case_when(Participated == 1 ~"TIP Participants",
                            Participated == 0 ~ "non TIP Participants"))
plot3data$'Years of Experience' <- plot3data$Strata


plot3 <- ggplot(plot3data, aes(x= Strata, y = `proportion`, fill = Strata)) +
  geom_bar(stat = "identity") +
  facet_wrap(~partic) +
  labs(title = "Proportion of Strata by Participation") +
  labs(fill = "Years of Experience")+
  ylab("Proportion") +
  theme(axis.text.x.bottom = element_blank()) +
  geom_text(size = 3.5,aes(label = percent(`proportion`), vjust = 1.7)) +
  ylim(0,1)

plot3
```


```{r chunk3.7, echo=FALSE, fig.show='hold', message=FALSE, warning=FALSE}


#create proportion tables
table_proportions <- table_plot %>%
  group_by(Strata, Retained, Participated) %>%
  dplyr::summarise(total = n()) %>%
  spread(key = Retained, value = total) %>%
  mutate(totals = `0` + `1`) %>%
  mutate(liklihood_not_retained = `0` / totals) %>%
  mutate(liklihood_retained = `1` / totals) %>%
           mutate(partic = case_when(Participated == 1 ~"TIP Participants",
                            Participated == 0 ~ "non TIP Participants"))
library(scales)

table_proportions$new <- percent(table_proportions$liklihood_retained)

plot2 <- ggplot(table_proportions, aes(x= Strata, y = as.numeric(`liklihood_retained`), fill = Strata)) +
  geom_bar(stat = "identity") +
  facet_wrap(~partic) +
  labs(title = "Liklihood of Retention by Participation and Strata") +
  ylab("Likelihood of Retention") +
  theme(axis.text.x.bottom=element_blank()) +
  geom_text(aes(label = `new`), vjust = 1.6) +
  ylim(0,1)

plot2


```



```{r chunk3.8.2, eval=FALSE, fig.show='hold', message=FALSE, warning=FALSE, include=FALSE}
#plot the other one too
#other way
rm(list = ls()) #clear the environment

##remove the year variables out of each
load("scripts/merged_participation_analysis.Rdata")

#first, create a new yeears_service table with variable

#THOSE WHO DID PARTICIPATE

table_1 <- merged_participation
table_1$`Years of Service` <- as.numeric(table_1$`Years of Service`)
table_1$`Participated` <- as.numeric(table_1$`Participated`)
table_1$Retained <- as.numeric(table_1$Retained)

table_try <- table_1 %>%
  select(`Years of Service`, Retained, Participated) %>%
  filter(Participated == 1) %>%
  group_by(`Years of Service`, Retained, Participated) %>%
  summarise(total_numer = n())
#new data framee with total sums
table_1_totals <- table_1 %>%
  select(`Years of Service`, Retained, Participated) %>%
  filter(Participated == 1) %>%
  group_by(`Years of Service`) %>%
  summarise(total = n ())
#merge that back with the previous
table_try <- merge(table_try, table_1_totals)
#can now do this one of two ways, first by the proportion that was retained, or by the other way
#later do this by parsing out the two
table_try_1 <- table_try %>% 
  mutate(prop = total_numer/total)

table_part <- table_try_1

#THOSE WHO DID NOT PARTICIPATE

#first, create a new yeears_service table with variable
table_1 <- merged_participation
table_1$`Years of Service` <- as.numeric(table_1$`Years of Service`)
table_1$`Participated` <- as.numeric(table_1$`Participated`)
table_1$Retained <- as.numeric(table_1$Retained)

table_try <- table_1 %>%
  select(`Years of Service`, Retained, Participated) %>%
  filter(Participated == 0) %>%
  group_by(`Years of Service`, Retained, Participated) %>%
  summarise(total_numer = n())
#new data framee with total sums
table_1_totals <- table_1 %>%
  select(`Years of Service`, Retained, Participated) %>%
  filter(Participated == 0) %>%
  group_by(`Years of Service`) %>%
  summarise(total = n ())
#merge that back with the previous

table_try <- merge(table_try, table_1_totals)

#can now do this one of two ways, first by the proportion that was retained, or by the other way
#later do this by parsing out the two
table_try_1 <- table_try %>% 
  mutate(prop = total_numer/total)
table_nonpart <- table_try_1


############what is we jsut merged the two tables

tables <- rbind(table_part, table_nonpart)
tables$Participated[tables$Participated == 1] <- "TIP Participants"
tables$Participated[tables$Participated == 0] <- "non-TIP Participants"

plot <- ggplot(data = tables, aes(x=`Years of Service`, y = `prop`)) +
  geom_point(aes(color = as.factor(`Retained`))) +
  facet_wrap(~`Participated`) +
  xlab("Years of Service") +
  ylab("Proportion Retained") +
  labs(color = "Retained") +
  ggtitle("Proportion Retention Breakdown") +
  xlim(0,30)
  
plot


```


In order to continue with a statistical analysis, we create an analysis dataset with a row for each Deidentified ID that has all of its unique variables. Recall that the merged_dataset has multiple rows for the same Deidentified ID. For instance, teacher ID #72 may have changed schools over the time we have the data. Or, teacher ID #72 may have changed their title (example: a Special Education teacher moving to a General Education teacher). In order to capture that change, we can come up with a new variable that records the number of times the teacher changed schools, titles, etc.

Variables that change for each ID, such as gender, or school, will be gathered and then re-coded. For instance, the original data set had a unique entry for each year in the data. Here, that is recoded as "total years in TIP data set". Or, some teachers changed gender over the time frame. This is recoded as "number of genders". Or, some teachers changed schools during the time frame. This is recoded as "number of schools".

### Logistic Regression

Phase 1 began with a visualization and descriptive analysis of the breakdown of teacher strata
and retention. After that, we analyzed the significance of participation in TIP on retention
through a logistic regression. Participating in TIP is associated with an increase in the log odd
likelihood of retention. Specifically, participating in TIP
was associated with a .35 increase in the log odds of retention.
Certain ethnicities, when ethnicity is added as a second predictor, are also associated with
increases in likelihood of retention.


```{r chunk4, echo=FALSE, fig.show='hold', message=FALSE, warning=FALSE}


#We create a new variable called switch_schools that is 1 if they switched schools or 0 if they stayed at the same school. We do the  same for ethnicity and title, capturing how many times teachers changed these variables

#repeats of schools
merged_variables_schools_switch <- merged_participation %>%
  select(Organization, `Deidentified ID`) %>%
  distinct() %>%
  arrange(`Deidentified ID`)
tally_switched_schools <- merged_variables_schools_switch %>%
  group_by(`Deidentified ID`) %>%
  tally() %>%
  mutate("number_of_schools_worked" = n) %>%
  select(`Deidentified ID`, number_of_schools_worked)

#repeats of ethnicity
merged_variables_ethnicity_switch <- merged_participation %>%
  select(Ethnicity, `Deidentified ID`) %>%
  distinct() %>%
  arrange(`Deidentified ID`)
tally_ethnicity_schools <- merged_variables_ethnicity_switch %>%
  group_by(`Deidentified ID`) %>%
  tally() %>%
  mutate("number_of_ethnicities" = n) %>%
  select(`Deidentified ID`, number_of_ethnicities)

#repeats of gender
merged_variables_gender_switch <- merged_participation %>%
  select(Gender, `Deidentified ID`) %>%
  distinct() %>%
  arrange(`Deidentified ID`)
tally_gender_schools <- merged_variables_gender_switch %>%
  group_by(`Deidentified ID`) %>%
  tally() %>%
  mutate("number_of_genders" = n) %>%
  select(`Deidentified ID`, number_of_genders)

#repeats of titles
merged_variables_titles_switch <- merged_participation %>%
  select(Title, `Deidentified ID`) %>%
  distinct() %>%
  arrange(`Title`)
tally_title_schools <- merged_variables_titles_switch %>%
  group_by(`Deidentified ID`) %>%
  tally() %>%
  mutate("number_of_titles" = n) %>%
  select(`Deidentified ID`, number_of_titles)

merged_participation <- merge(merged_participation, tally_switched_schools, by = "Deidentified ID")
merged_participation <- merge(merged_participation, tally_gender_schools, by = "Deidentified ID")
merged_participation <- merge(merged_participation, tally_ethnicity_schools, by = "Deidentified ID")
merged_participation <- merge(merged_participation, tally_title_schools, by = "Deidentified ID")


#from the merged_participation_analysis, we can move forward with regressions and analyses in the next chunks of code, by picking out the variables of interest and choosing "distinct"



```

Model 1


$$log(r/(1-r)) = \beta_0 + \beta_1{x_1} + \beta_2{x_2} +... \beta_p{x_p}$$
The logistic regression model (above) forms the basis for the following statistical tests. Where r is proability of a teacher being retained or not retained, and each x represents a possible predictor, such as gender or years of service in the district, then the model tests the significance of each regression coefficient in predicting the log odds of retention.



$$log(r/(1-r)) = \beta_0 + \beta_1{x_1}$$

$$\beta_1 = Participation $$

The output of Model 1 shows that participation in TIP increases the log odds of retention by 0.35. In other words, TIP teachers are 35% more likely to be retained than non-TIP teachers. This value is statistically significant, given that p <.05.


```{r chunk5, echo=FALSE, fig.show='hold', message=FALSE, warning=FALSE}


#Create a new data frame that chooses teacher status based on the first one in that data set

analysis_data <- merged_participation %>%
  arrange(`Deidentified ID`, `Employee Age`) %>%
  group_by(`Deidentified ID`,Strata, Retained, Participated) %>%
  group_by(`Deidentified ID`) %>%
  filter(row_number() == 1) #choosing the first row for each Deidentified ID

#recode the levels of strata
analysis_data$Strata <- as.factor(analysis_data$Strata)
analysis_data$Strata <- recode_factor(analysis_data$Strata, `1` = "less than 5", `2` = "5 to less than 10 years", `3` = "10 to 15 years", `4` = "greater than or equal to 15")
#make the other variables factors
analysis_data$Gender <- as.factor(analysis_data$Gender)
analysis_data$Ethnicity <- as.factor(analysis_data$Ethnicity)
analysis_data$`Employee Age` <- as.numeric(analysis_data$`Employee Age`)
analysis_data$Retained <- as.numeric(analysis_data$Retained)
analysis_data$Participated <- as.factor(analysis_data$Participated)
analysis_data$Title <- as.factor(analysis_data$Title)

library(dplyr)
#for analysis purposes, we next want to find out where missing data are for participants
#sum(is.na(analysis_data$Gender)) #there are 9 missing values for Gender, so we remove these
analysis_data <- analysis_data[!is.na(analysis_data$Gender),]

#model1: predicting retention by participation in TIP

logit1 <- glm(Retained ~ Participated, data = analysis_data, family = binomial)
summary(logit1)

library(pander)
library(xtable)
table <- logit1$coefficients
kable(table)

```


Model 2

Model 2. Does the effect of TIP on the log odds of retention differ when controlling for gender
and ethnicity?

$$log(r/(1-r)) = \beta_0 + \beta_1{x_1} + \beta_2{x_2} $$


$$log(r/(1-r)) = \beta_0 + \beta_1{x_1}$$

$$\beta_1 = Participation $$
$$\beta_2 = Gender $$
$$\beta_3 = Ethnicity $$

```{r chunk5.54, echo=FALSE, fig.show='hold', message=FALSE, warning=FALSE}

logit2 <- glm(Retained ~ Participated  +Ethnicity , data = analysis_data, family = binomial)
logit2
summary(logit2)
table
kable(table)
```

In the table above, the reference ethnicity group (intercept term) refers to teachers who identified
as African-American. As a result, all coefficients for the ethnicity variables are comparisons
between the specified ethnicity group and African-American teachers. The table above shows
that, among African-American teachers, participating in TIP improved their log odds of retention
by a factor of 0.349 on the log odds scale.
Among the other ethnicity groups, the coefficients associated with Caucasian and Latina teachers
are also statistically significant. Interestingly, for Caucasian teachers who participated in TIP, the
log odds of retention are actually lower compared to non-TIP African-American teachers. This is
seen by the -0.097 coefficient. On the other hand, the log odds is higher among Latina TIP
participants compared to the reference group of non-TIP African-American teachers. 



### Causal Analysis

In Phase 1 of the analysis, teachers who participated in TIP were more likely to be retained.
Additionally, the effect of participation may have been larger for some groups. For instance, the
effect of TIP on retention was significantly higher for teachers who identified as African
American or Latinx, and lower for teachers who identified as Caucasian. On the other hand, prior
years of experience and gender were not significant.
The logistic regression in Phase 1 performs well as a classification method in predicting which
teachers will be retained based on participation in TIP. The logistic regression also allows us to
explore associative relationships among variables related to retention. However, the logistic
regression is limited in its ability to express a causal relationship between participating in TIP
and retention.
In Phase 2, we add rigor to the logistic regression by asking if there is a causal relationship
between participation in TIP and retention. We match teachers based on available and measured
covariates, such as years in the classroom, gender, or title (classroom teacher or administration).
By matching, we reduce the chance that these factors (whether or not the teacher is a male or
female, for instance) explain retention. Instead, the variable of causal interest (whether or not the
teacher participated in the intervention) is isolated.
We spent ample time exploring the differences in groups for each measured covariates, since the
goal of balancing will depend on the raw differences in the sample size representation of each of
these covariates. Appendix A includes differences in covariate groups among TIP and non-TIP
teachers. The impacts of each covariate on the percent balance improvement among TIP and
non-TIP teachers was considered, and in the end we chose to trim the sample to include only the
ages of teachers who participated in TIP.
To be more specific, certain ages of teachers are represented in the non-TIP sample, yet not
represented in the Treatment (TIP) sample. The ages that are not represented in the TIP samples
are: 32, 38, and 40+. Especially in the context of our study, where the question of interest is
teacher retention, then an important confounder of staying in the classroom is age of the teacher.
Therefore, matching on age without taking into account these non-representative ages may affect
the balance allowed on other variables (specifically gender and ethnicity). 300 non-participating
teachers were not matched in the age of the TIP participating teachers.
Trimming the sample has the effect of improving percent balance improvement for Gender and
the other category of Ethnicity. In fact, all of the variables now have sufficient percent balance
improvement. Appendix A includes the original matching model with all covariates included,
and describes how the percent balance improvement informed the selection of covariates in our
final matching model, presented below. This final model includes the trimmed TIP sample so 
that we only include TIP teachers with Years of experience that are matched in the other sample
of non-TIP teachers.





```{r, include=FALSE}
#install.packages("MatchIt")
library(MatchIt)
library(broom)
library(tidyverse)

rm(list = ls()) #clear the environment
load("scripts/merged_participation_analysis.Rdata")
data <- merged_participation
table(data$Participated)

######
# PART 2- Change factor and data clearn
########

#For our data, we will want to choose the max years that the teachers participated
analysis_data <- aggregate(`Years of Service` ~ `Deidentified ID`, data, max)
analysis_data <- merge(analysis_data, merged_participation)
analysis_data <- unique(analysis_data, by = 'Deidentified ID')
table(analysis_data$Participated) #312 participated in tip
#change outcome to factor
analysis_data$Retained <- as.factor(analysis_data$Retained)

## redo the logistic regression models
model <- glm(Retained ~ Participated, data = analysis_data, family = binomial)
summary(model) #participated is a significant predictors of retention
model2 <- glm(Retained ~ Participated + `Employee Age`, data = analysis_data, family = binomial)
summary(model2)
model3 <- glm(Retained ~ Participated + Strata, data = analysis_data, family = binomial)
summary(model3)
model4 <- glm(Retained ~ Participated + Ethnicity, data = analysis_data, family = binomial)
summary(model4) ##Interactions of Ethnicity

######
# PART 3- Visualize Distributions/Matchings
########

#numerical variables
data <- analysis_data %>%
  group_by(Participated) %>%
  summarise(n_parts = n(),
            mean_years_service = mean(`Years of Service`),
            mean_age = mean(`Employee Age`))
data
table(analysis_data$Strata, analysis_data$Participated)
table(analysis_data$`Employee Age`, analysis_data$Participated)
#categorical variables
table(analysis_data$Title, analysis_data$Participated)
table(analysis_data$Gender, analysis_data$Participated)
table(analysis_data$Ethnicity, analysis_data$Participated)
table(analysis_data$`HOME ORG CODE`, analysis_data$Participated)


######
# PART 4- Create binary indicators
########

analysis_data <- analysis_data %>%
  select(Ethnicity, Title, Gender, `Employee Age`, Participated,
         Retained, `HOME ORG CODE`, `Years of Service`, Strata,
         `Deidentified ID`)
#recode teachers
analysis_data$title_status <- ifelse(analysis_data$Title ==
                                       "TEACHER,FULL TIME"| analysis_data$Title ==
                                       "TEACHER,SPEC EDUCATION",
                                     
                                     'teacher','non_classroom_teacher')

#recode ethnicity
analysis_data$Ethnicity <- ifelse(analysis_data$Ethnicity ==
                                    "NAT AM/INUIT"| analysis_data$Ethnicity ==
                                    "OTHER" | analysis_data$Ethnicity ==
                                    "PREF NO DISC",
                                  
                                  'other',analysis_data$Ethnicity)

##recode employee age
analysis_data <- mutate(analysis_data,
                        Age = case_when(
                          `Employee Age` >= 70 ~ "70s",
                          `Employee Age` >=60 & `Employee Age`< 70 ~ "60s",
                          `Employee Age` >=50 & `Employee Age`< 60 ~ "50s",
                          `Employee Age` >=40 & `Employee Age`< 50 ~ "40s",
                          `Employee Age` >=30 & `Employee Age`< 40 ~ "30s",
                          `Employee Age` >=20 & `Employee Age`< 30 ~ "20s"
                        ))
table(analysis_data$Age, analysis_data$Participated)
table(analysis_data$Ethnicity, analysis_data$Participated)
table(analysis_data$title_status, analysis_data$Participated)

##add indicator variable for the categorical variables
analysis_data <- mutate(analysis_data,
                        title_binary= case_when(
                          title_status == "teacher" ~ 1,
                          title_status != "teacher" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        strata_binary_10_15= case_when(
                          Strata == "10 to 15 years" ~ 1,
                          Strata != "10 to 15" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        strata_binary_5_10= case_when(
                          Strata == "5 to less than 10 years" ~ 1,
                          Strata != "5 to less than 10 years" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        strata_binary_less_5= case_when(
                          Strata == "less than 5" ~ 1,
                          Strata != "less than 5" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        strata_binary_greater_15= case_when(
                          Strata == "greater than or equal to 15" ~ 1,
                          Strata != "greater than or equal to 15" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        ethnicity_binary_african_am= case_when(
                          Ethnicity == "AFRICAN AM" ~ 1,
                          Ethnicity != "AFRICAN AM" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        ethnicity_binary_caucasian =case_when(
                          Ethnicity == "CAUCASIAN" ~ 1,
                          Ethnicity != "CAUCASIAN" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        ethnicity_binary_asian =case_when(
                          Ethnicity == "ASIAN" ~ 1,
                          Ethnicity != "ASIAN" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        ethnicity_binary_latina =case_when(
                          Ethnicity == "LATINA/O" ~ 1,
                          Ethnicity != "LATINA/O" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        ethnicity_binary_other =case_when(
                          Ethnicity == "other" ~ 1,
                          Ethnicity != "other" ~ 0
                        ))


analysis_data <- mutate(analysis_data,
                        gender_binary_female =case_when(
                          Gender == "F" ~ 1,
                          Gender != "F" ~ 0
                        ))
analysis_data <- mutate(analysis_data,
                        gender_binary_male =case_when(
                          Gender == "M" ~ 1,
                          Gender != "M" ~ 0
                        ))


######
# PART 5- Visualize Region of Common Support
########

###visualizations
library(ggplot2)
p <- ggplot(analysis_data, aes(fill = factor(Participated))) +
  geom_bar(position = "dodge") +
  scale_fill_discrete("Smoke")
p + aes(x=Ethnicity)
p + aes(x = Gender)
p + aes(x= title_status)

###look at distribution
ggplot(analysis_data, aes(x = `Employee Age`, fill = factor(Participated))) +
  geom_histogram(position = "identity") +
  scale_fill_discrete("Participated")

###or we can look at the quantiles within each group
tapply(analysis_data$`Employee Age`, analysis_data$Participated, 
       quantile, probs = seq(0.2,1,0.1))
tapply(analysis_data$`Years of Service`, analysis_data$Participated, 
       quantile, probs = seq(0.2,1,0.1))

##region of common support
analysis_data %>%
  ggplot(aes(x = `Employee Age`)) +
  geom_histogram(position = "identity") +
  facet_wrap(~Participated)
analysis_data %>%
  ggplot(aes(x = `Years of Service`)) +
  geom_histogram(position = "identity") +
  facet_wrap(~Participated)


```

```{r pressure, echo=TRUE}

### Matching 1- All covariates in the matching model
##set seed
set.seed(1731)
analysis_data$Gender <- as.factor(analysis_data$Gender)
analysis_data$employeeage <- as.numeric(analysis_data$`Employee Age`)
analysis_data$title_status <- as.factor(analysis_data$title_status)
analysis_data$Ethnicity <- as.factor(analysis_data$Ethnicity)
analysis_data$HomeOrgCode <- as.factor(analysis_data$`HOME ORG CODE`)
analysis_data$YearsOfService <- as.numeric(analysis_data$`Years of Service`)
nearest <- matchit(Participated ~
                     Gender+ Ethnicity + Strata + employeeage+ title_status
                     ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data)
summary(nearest)
###plotting these
#plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
summary(model)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


Trim the non TIP sample so that it is only tip in terms of Years of Experience. 32 years olds, 38 year olds, and 40 or older are missing from the TIP teacher group. However, these
groups ARE represented in the non-TIP sample.


```{r pressure2, echo=TRUE}
set.seed(1731)
# trimming the sample
analysis_data_trimmed <- analysis_data %>%
  filter(YearsOfService %in% c(0:31, 33,34,35,36,37,39))

nearest <- matchit(Participated ~
                     Gender+ Ethnicity + Strata + employeeage+ title_status
                     ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data_trimmed)
summary(nearest)
###plotting these
plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
summary(model)
```




Coursen the Ethnicity Variable

Coursen the Ethnicity variable. Match by Caucasian and non-Caucasian


```{r pressure3, echo=TRUE}
analysis_data <- analysis_data %>%
  mutate(Caucasian_binary = ifelse(Ethnicity == "CAUCASIAN", 1, 0))
analysis_data$Caucasian_binary <- as.factor(analysis_data$Caucasian_binary)
set.seed(111731)
nearest <- matchit(Participated ~
                     Gender+ Caucasian_binary + Strata + employeeage+ title_status
                     ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data)
summary(nearest)
###plotting these
#plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
summary(model)

table(analysis_data$Age, analysis_data$Caucasian_binary)

```


```{r pressure4, echo=TRUE}
analysis_data_trimmed <- analysis_data_trimmed %>%
  mutate(Caucasian_binary = ifelse(Ethnicity == "CAUCASIAN", 1, 0))
analysis_data_trimmed$Caucasian_binary <- as.factor(analysis_data_trimmed$Caucasian_binary)
set.seed(1731)
nearest <- matchit(Participated ~
                     Gender+ Caucasian_binary + Strata + employeeage+ title_status
                     ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data_trimmed)
summary(nearest)
###plotting these
#plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
summary(model)

```




### Future Directions

In conjunction with Phase 1 of the study, Phase 2 implies that participation in TIP may have a  causal effect on the retention of teachers in the Philadelphia school district, when teachers are  matched on the measured covariates. All else things being equal that are associated with  retention (gender, ethnicity, age, years in the classroom, and title), then those who participate in  TIP are more likely to be retained, within the time period of our study. Limitations to this  conclusion include the small sample size of TIP participants, and a myriad of other confounders  that could have been measured. 
In broader implications of the study, we first consider the associations in ethnicity found in Phase  1 that may be of interest to certain minority groups. From a psychological standpoint, students  who have a teacher who “looks like them” (such as similar gender or Ethnicity) are predicted to  build stronger relationships in the classroom, and relationship building is frequently tied to  academic performance and interest. One study looked at this so called “Teacher Match” on  students’ academic perceptions and attitudes. The study found that demographically similar  teachers, “especially in gender matches” are significant in the quality of student-teacher  communication and college aspiration.1 If retaining those groups of teachers is a driver in  reducing disparities in education among certain ethnic and gender groups, then better  understanding how different programs lead to disparate outcomes of retention for different  groups of teachers (gender/ethnicity) would be an important next step for TIP. 
Further research would likewise do well to explore this interaction between ethnicity, age, and  gender. White teachers are more represented in the 20s and 30s group of teachers than non-white  teachers (about 23% of teachers in their 20s are nonwhite, and 26% of teachers in their 20s are non-white, while 75% of teachers in their 50s are non-white), but the limitations of this study in  sample size of ethnicity and gender prevent that question from being directly addressed. 

A second broader implication is from the teacher, rather than the student, perspective. Teacher retention is a much studied topic, and programs like TIP, which enable teachers to pursue  university-level study, thereby bringing new content to students and increasing teachers’ morale,  are rooted in the mission to keep teachers helping those students who need them most. Both  authors of this study were public school teachers themselves, and know that “intellectual  engagement” is certainly as important as “purpose” in a career. One possible explanation behind  the increased retention of teachers who participate in TIP may by this intellectual engagement  that the program offers. 

There remains unanswered questions in this domain that the TIP organization can continue to  pursue and work to address. Specifically, what are the outcomes of teachers who do leave the  district, after participating in TIP? Our study was limited to a binary variable of retained or not  retained. This lacks a very important other possibility, which is that teachers left their role in  SDP to pursue other intellectually engaging and purpose driven opportunities, such as a doctorate  in education or starting their own computer programming boot-camp for minority students in Philadelphia. It is hard to argue that these teachers are contributing to educational inequity by  leaving their classroom positions. TIP can continue to reach out to teachers who leave to learn  qualitatively about the specifics of roles that former teachers are pursuing outside of the  classroom role, and whether or not participating in TIP actually encouraged them to seek these  roles that are equally as influential as the work of a classroom teacher. 
 
